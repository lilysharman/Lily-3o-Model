<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>8-Class Classifier (TM-Matching)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Upload a Folder of Images</h1>
  <input type="file" id="imageUpload" accept="image/*" multiple webkitdirectory /><br>
  <button id="downloadExcel" style="display:none;">Download Excel</button>
  <div id="predictionResults" style="margin-top: 20px; font-family: monospace;"></div>

  <script>
    let model;

    // 💡 Capitalised labels to match exactly what's in the model
    const labels = ["AGEING AD", "AD", "PSP", "CBD", "PICKS", "GGT", "CTE", "PART"];
    const predictionsData = [];

    async function loadModel() {
      const modelURL = "model.json";
      const metadataURL = "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      console.log("✅ Model loaded");
    }

    async function predict(image) {
      const prediction = await model.predict(image);
      const result = {};

      for (const label of labels) {
        const match = prediction.find(p => p.className === label);
        result[label] = match ? (match.probability * 100).toFixed(2) : "0.00";
      }

      return result;
    }

    document.getElementById("imageUpload").addEventListener("change", async (e) => {
      const files = e.target.files;
      const resultsDiv = document.getElementById("predictionResults");
      resultsDiv.innerHTML = "";
      predictionsData.length = 0;

      let processedCount = 0;
      let failedCount = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const img = new Image();
        img.src = URL.createObjectURL(file);

        await new Promise((resolve) => {
          img.onload = async () => {
            try {
              const prediction = await predict(img);
              const row = { Image: file.name };

              const displayParts = [`Image: ${file.name}`];
              for (const label of labels) {
                row[label] = prediction[label];
                displayParts.push(`${label}: ${prediction[label]}%`);
              }

              const div = document.createElement("div");
              div.textContent = displayParts.join(" | ");
              resultsDiv.appendChild(div);

              predictionsData.push(row);
              processedCount++;
            } catch (error) {
              console.error(`❌ Failed to process ${file.name}`, error);
              failedCount++;
            }
            resolve();
          };

          img.onerror = () => {
            console.error(`❌ Failed to load image: ${file.name}`);
            failedCount++;
            resolve();
          };
        });
      }

      if (processedCount > 0) {
        document.getElementById("downloadExcel").style.display = "block";
      }

      console.log(`✅ Done: ${processedCount} processed, ${failedCount} failed.`);
    });

    document.getElementById("downloadExcel").addEventListener("click", () => {
      const ws = XLSX.utils.json_to_sheet(predictionsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Predictions");
      XLSX.writeFile(wb, "Predictions.xlsx");
    });

    loadModel();
  </script>
</body>
</html>
